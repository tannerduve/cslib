#!/usr/bin/env bash
set -euxo pipefail

BENCH="scripts/bench"

# Prepare build
lake exe cache get

# Run build
LAKE_OVERRIDE_LEAN=true LEAN=$(realpath "$BENCH/build/fake-root/bin/lean") \
  "$BENCH/measure.py" -t build \
  -m instructions -m maxrss -m task-clock -m wall-clock -- \
  lakeprof record lake build --no-cache

# Analyze lakeprof data
lakeprof report -pj | jq -c '{metric: "build/lakeprof/longest build path//wall-clock", value: .[-1][2], unit: "s"}' >> measurements.jsonl
lakeprof report -rj | jq -c '{metric: "build/lakeprof/longest rebuild path//wall-clock", value: .[-1][2], unit: "s"}' >> measurements.jsonl
